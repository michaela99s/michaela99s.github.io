---
layout: post
title: 전처리 - 결측치처리
description: >
  전처리 - 결측치 처리
sitemap: false
hide_last_modified: true
---


실제 데이터를 분석하다보면 결측치를 쉽게 만나볼 수 있습니다. 따라서 결측치 처리는 데이터 전처리 과정에 있어서 매우 중요한 부분을 차지하고 있다고 볼 수 있습니다. 

결측치가 포함된 자료를 불러와서 처리해봅시다.

```python
import pandas as pd

data = pd.read_csv('Ex_Missing.csv')
data
```

|     | salary | sales        | roe       | industry |
| --- | ------ | ------------ | --------- | -------- |
| 0   | 1095.0 | 27595.000000 | 14.100000 | 1        |
| 1   | NaN    | 9958.000000  | 10.900000 | 1        |
| 2   | NaN    | 6125.899902  | 23.500000 | 1        |
| 3   | 578.0  | 16246.000000 | 5.900000  | 1        |
| 4   | 1368.0 | NaN          | 13.800000 | 1        |
| 5   | 1145.0 | NaN          | 20.000000 | 2        |
| 6   | 1078.0 | 2266.699951  | 16.400000 | 2        |
| 7   | 1094.0 | 2966.800049  | 16.299999 | 2        |
| 8   | 1237.0 | 4570.200195  | 10.500000 | 2        |
| 9   | 833.0  | 2830.000000  | NaN       | 2        |

### 결측치 확인

판다스의 `isnull()` 함수는 불리안 형태로 결측 여부를 반환합니다. 결측이면 True를, 결측이 아니면 False를 반환합니다. 

```python
data.isnull()
# 또는 
# pd.isnull(data)
```

|     | salary | sales | roe   | industry |
| --- | ------ | ----- | ----- | -------- |
| 0   | False  | False | False | False    |
| 1   | True   | False | False | False    |
| 2   | True   | False | False | False    |
| 3   | False  | False | False | False    |
| 4   | False  | True  | False | False    |
| 5   | False  | True  | False | False    |
| 6   | False  | False | False | False    |
| 7   | False  | False | False | False    |
| 8   | False  | False | False | False    |
| 9   | False  | False | True  | False    |

칼럼별로 결측치를 확인하기 위해서는 `isnull().sum()`을 사용할 수 있습니다. 특정 칼럼의 결측치 수를 확인하기 위해서는 `DataFrame['column'].isnull().sum()`을 사용하면 됩니다. 또한 결측이 아닌 경우를 탐색할 때에는 `isnull()`이 아닌 `notnull()`이 사용됩니다.

```python
data.isnull().sum()
```

```
salary      2
sales       2
roe         1
industry    0
dtype: int64
```

또한, `info()`를 통해서도 한 번에 파악이 가능합니다. 

```python
data.info()
```

```
<class 'pandas.core.frame.DataFrame'>
RangeIndex: 10 entries, 0 to 9
Data columns (total 4 columns):
 #   Column    Non-Null Count  Dtype  
---  ------    --------------  -----  
 0   salary    8 non-null      float64
 1   sales     8 non-null      float64
 2   roe       9 non-null      float64
 3   industry  10 non-null     int64  
dtypes: float64(3), int64(1)
memory usage: 448.0 bytes
```

행별로 결측을 확인할 수도 있습니다. `sum()`의 괄호 안에 1을 넣어주면 행을 기준으로 합산합니다. 

```python
data.isnull().sum(1)
```

```
0    0
1    1
2    1
3    0
4    1
5    1
6    0
7    0
8    0
9    1
dtype: int64
```

이를 활용하여 행 단위 결측치 수를 나타내는 새 변수를 생성합니다.

```python
data['missing'] = data.isnull().sum(1)
data
```

|     | salary | sales        | roe       | industry | missing |
| --- | ------ | ------------ | --------- | -------- | ------- |
| 0   | 1095.0 | 27595.000000 | 14.100000 | 1        | 0       |
| 1   | NaN    | 9958.000000  | 10.900000 | 1        | 1       |
| 2   | NaN    | 6125.899902  | 23.500000 | 1        | 1       |
| 3   | 578.0  | 16246.000000 | 5.900000  | 1        | 0       |
| 4   | 1368.0 | NaN          | 13.800000 | 1        | 1       |
| 5   | 1145.0 | NaN          | 20.000000 | 2        | 1       |
| 6   | 1078.0 | 2266.699951  | 16.400000 | 2        | 0       |
| 7   | 1094.0 | 2966.800049  | 16.299999 | 2        | 0       |
| 8   | 1237.0 | 4570.200195  | 10.500000 | 2        | 0       |
| 9   | 833.0  | 2830.000000  | NaN       | 2        | 1       |

### 결측치 처리

#### 결측치 제거

결측치 제거에는 판다스의 `dropna()`를 사용할 수 있습니다. 

```python
pandas.DataFrame.dropna(axis=0, how='any', thresh=None, subset=None, 
inplace=False)
```

​`axis=0`으로 설정하면 결측치가 있는 행을 제거합니다. 

```python
data_del_row = data.dropna()
data_del_row
```

|     | salary | sales        | roe       | industry | missing |
| --- | ------ | ------------ | --------- | -------- | ------- |
| 0   | 1095.0 | 27595.000000 | 14.100000 | 1        | 0       |
| 3   | 578.0  | 16246.000000 | 5.900000  | 1        | 0       |
| 6   | 1078.0 | 2266.699951  | 16.400000 | 2        | 0       |
| 7   | 1094.0 | 2966.800049  | 16.299999 | 2        | 0       |
| 8   | 1237.0 | 4570.200195  | 10.500000 | 2        | 0       |

`axis=1`로 설정하게 된다면 결측치가 있는 칼럼 전체를 제거하게 됩니다.

```python
data_del_col = data.dropna(axis=1)
data_del_col
```

|     | industry | missing |
| --- | -------- | ------- |
| 0   | 1        | 0       |
| 1   | 1        | 1       |
| 2   | 1        | 1       |
| 3   | 1        | 0       |
| 4   | 1        | 1       |
| 5   | 2        | 1       |
| 6   | 2        | 0       |
| 7   | 2        | 0       |
| 8   | 2        | 0       |
| 9   | 2        | 1       |

#### 결측값 대체

결측값 대체에는 `fillna()`를 사용할 수 있습니다.

```python
pandas.DataFrame.fillna(value=None, method=None, axis=None, 
inplace=False, limit=None, downcast=None)
```

##### 특정값으로 대체

결측치를 0으로 대체해보도록 하겠습니다.

```python
data_0 = data.fillna(0)
data_0
```

|     | salary | sales        | roe       | industry | missing |
| --- | ------ | ------------ | --------- | -------- | ------- |
| 0   | 1095.0 | 27595.000000 | 14.100000 | 1        | 0       |
| 1   | 0.0    | 9958.000000  | 10.900000 | 1        | 1       |
| 2   | 0.0    | 6125.899902  | 23.500000 | 1        | 1       |
| 3   | 578.0  | 16246.000000 | 5.900000  | 1        | 0       |
| 4   | 1368.0 | 0.000000     | 13.800000 | 1        | 1       |
| 5   | 1145.0 | 0.000000     | 20.000000 | 2        | 1       |
| 6   | 1078.0 | 2266.699951  | 16.400000 | 2        | 0       |
| 7   | 1094.0 | 2966.800049  | 16.299999 | 2        | 0       |
| 8   | 1237.0 | 4570.200195  | 10.500000 | 2        | 0       |
| 9   | 833.0  | 2830.000000  | 0.000000  | 2        | 1       |

이번에는 'missing'이라는 문자로 결측치를 대체하도록 하겠습니다.

```python
data_missing = data.fillna('missing')
data_missing
```

​

|     | salary  | sales       | roe       | industry | missing |
| --- | ------- | ----------- | --------- | -------- | ------- |
| 0   | 1095.0  | 27595.0     | 14.1      | 1        | 0       |
| 1   | missing | 9958.0      | 10.9      | 1        | 1       |
| 2   | missing | 6125.899902 | 23.5      | 1        | 1       |
| 3   | 578.0   | 16246.0     | 5.9       | 1        | 0       |
| 4   | 1368.0  | missing     | 13.8      | 1        | 1       |
| 5   | 1145.0  | missing     | 20.0      | 2        | 1       |
| 6   | 1078.0  | 2266.699951 | 16.4      | 2        | 0       |
| 7   | 1094.0  | 2966.800049 | 16.299999 | 2        | 0       |
| 8   | 1237.0  | 4570.200195 | 10.5      | 2        | 0       |
| 9   | 833.0   | 2830.0      | missing   | 2        | 1       |

`fillna()`의 옵션 중 `method`에는 {'backfill', 'bfill', 'pad', 'ffill', None}을 지정할 수 있습니다. pad/ffill은 결측치를 그 앞의 값으로 대체하는 옵션입니다. backfill/bfill은 결측치를 그 뒤의 값으로 대체하는 옵션입니다. 

```python
data_f = data.fillna(method='ffill')
data_f
```

|     | salary | sales        | roe       | industry | missing |
| --- | ------ | ------------ | --------- | -------- | ------- |
| 0   | 1095.0 | 27595.000000 | 14.100000 | 1        | 0       |
| 1   | 1095.0 | 9958.000000  | 10.900000 | 1        | 1       |
| 2   | 1095.0 | 6125.899902  | 23.500000 | 1        | 1       |
| 3   | 578.0  | 16246.000000 | 5.900000  | 1        | 0       |
| 4   | 1368.0 | 16246.000000 | 13.800000 | 1        | 1       |
| 5   | 1145.0 | 16246.000000 | 20.000000 | 2        | 1       |
| 6   | 1078.0 | 2266.699951  | 16.400000 | 2        | 0       |
| 7   | 1094.0 | 2966.800049  | 16.299999 | 2        | 0       |
| 8   | 1237.0 | 4570.200195  | 10.500000 | 2        | 0       |
| 9   | 833.0  | 2830.000000  | 10.500000 | 2        | 1       |

```python
data_b = data.fillna(method='bfill')
data_b
```

|     | salary | sales        | roe       | industry | missing |
| --- | ------ | ------------ | --------- | -------- | ------- |
| 0   | 1095.0 | 27595.000000 | 14.100000 | 1        | 0       |
| 1   | 578.0  | 9958.000000  | 10.900000 | 1        | 1       |
| 2   | 578.0  | 6125.899902  | 23.500000 | 1        | 1       |
| 3   | 578.0  | 16246.000000 | 5.900000  | 1        | 0       |
| 4   | 1368.0 | 2266.699951  | 13.800000 | 1        | 1       |
| 5   | 1145.0 | 2266.699951  | 20.000000 | 2        | 1       |
| 6   | 1078.0 | 2266.699951  | 16.400000 | 2        | 0       |
| 7   | 1094.0 | 2966.800049  | 16.299999 | 2        | 0       |
| 8   | 1237.0 | 4570.200195  | 10.500000 | 2        | 0       |
| 9   | 833.0  | 2830.000000  | NaN       | 2        | 1       |

후진대체의 경우 마지막 행에서 발생한 결측치는 다음 행의 값이 없기 때문에 대체 될 수 없고 결측인 상태로 남게 됩니다.

##### 평균 대체

```python
data_mean = data.fillna(data.mean())
data_mean
```

|     | salary | sales        | roe       | industry | missing |
| --- | ------ | ------------ | --------- | -------- | ------- |
| 0   | 1095.0 | 27595.000000 | 14.100000 | 1        | 0       |
| 1   | 1053.5 | 9958.000000  | 10.900000 | 1        | 1       |
| 2   | 1053.5 | 6125.899902  | 23.500000 | 1        | 1       |
| 3   | 578.0  | 16246.000000 | 5.900000  | 1        | 0       |
| 4   | 1368.0 | 9069.825012  | 13.800000 | 1        | 1       |
| 5   | 1145.0 | 9069.825012  | 20.000000 | 2        | 1       |
| 6   | 1078.0 | 2266.699951  | 16.400000 | 2        | 0       |
| 7   | 1094.0 | 2966.800049  | 16.299999 | 2        | 0       |
| 8   | 1237.0 | 4570.200195  | 10.500000 | 2        | 0       |
| 9   | 833.0  | 2830.000000  | 14.600000 | 2        | 1       |

`data.mean()` 대신에 `data.median()`, `data.max()`, `data.min()`을 넣어준다면 각각, 중앙값, 최대값, 최소값으로 결측치를 대체하게 됩니다.

마찬가지로 결측치를 특정 변수의 평균값으로 대체하고자 한다면  `data['column'].mean()` 또는 `data.mean()['column']`을 넣어주면 됩니다.

##### 다른 변수 값으로 대체

numpy의 `where` 함수를 활용하여 값을 대체할 수 있습니다. 

```python
numpy.where(condition, [x, y, ]/)
```

condition 조건에 따라 조건에 부합하면 x를, 부합하지 않으면 y를 반환합니다. 

sales_new 칼럼을 생성하여 만약 sales에 결측이 없으면 그대로 sales 값을 쓰고, 결측이 있으면 salary의 값으로 대체하도록 합니다.  

```python
import numpy as np
```

```python
data2 = data.copy()
data2['sales_new'] = np.where(pd.notnull(data2['sales']) == True,
                              data2['sales'], data2['salary'])
data2
```

|     | salary | sales        | roe       | industry | missing | sales_new    |
| --- | ------ | ------------ | --------- | -------- | ------- | ------------ |
| 0   | 1095.0 | 27595.000000 | 14.100000 | 1        | 0       | 27595.000000 |
| 1   | NaN    | 9958.000000  | 10.900000 | 1        | 1       | 9958.000000  |
| 2   | NaN    | 6125.899902  | 23.500000 | 1        | 1       | 6125.899902  |
| 3   | 578.0  | 16246.000000 | 5.900000  | 1        | 0       | 16246.000000 |
| 4   | 1368.0 | NaN          | 13.800000 | 1        | 1       | 1368.000000  |
| 5   | 1145.0 | NaN          | 20.000000 | 2        | 1       | 1145.000000  |
| 6   | 1078.0 | 2266.699951  | 16.400000 | 2        | 0       | 2266.699951  |
| 7   | 1094.0 | 2966.800049  | 16.299999 | 2        | 0       | 2966.800049  |
| 8   | 1237.0 | 4570.200195  | 10.500000 | 2        | 0       | 4570.200195  |
| 9   | 833.0  | 2830.000000  | NaN       | 2        | 1       | 2830.000000  |

##### 집단 평균값으로 대체

전체 평균이 아닌 그룹별 평균으로 대체하는 것이 더 현실적일 수 있습니다. 따라서 industry별로 평균을 구해 결측치를 대체하도록 하겠습니다. 

먼저 industry별 평균을 확인해보겠습니다.

```python
data.groupby('industry').mean()
```

|          | salary      | sales        | roe   | missing |
| -------- | ----------- | ------------ | ----- | ------- |
| industry |             |              |       |         |
| 1        | 1013.666667 | 14981.224976 | 13.64 | 0.6     |
| 2        | 1077.400000 | 3158.425049  | 15.80 | 0.4     |

lambda 함수를 구성하여 산업별로 평균대체를 합니다.

```python
fill_mean_func = lambda g: g.fillna(g.mean())

data_group_mean = data.groupby('industry').apply(fill_mean_func)
data_group_mean
```

|     | salary      | sales        | roe       | industry | missing |
| --- | ----------- | ------------ | --------- | -------- | ------- |
| 0   | 1095.000000 | 27595.000000 | 14.100000 | 1        | 0       |
| 1   | 1013.666667 | 9958.000000  | 10.900000 | 1        | 1       |
| 2   | 1013.666667 | 6125.899902  | 23.500000 | 1        | 1       |
| 3   | 578.000000  | 16246.000000 | 5.900000  | 1        | 0       |
| 4   | 1368.000000 | 14981.224975 | 13.800000 | 1        | 1       |
| 5   | 1145.000000 | 3158.425049  | 20.000000 | 2        | 1       |
| 6   | 1078.000000 | 2266.699951  | 16.400000 | 2        | 0       |
| 7   | 1094.000000 | 2966.800049  | 16.299999 | 2        | 0       |
| 8   | 1237.000000 | 4570.200195  | 10.500000 | 2        | 0       |
| 9   | 833.000000  | 2830.000000  | 15.800000 | 2        | 1       |

산업별 평균을 사용할 수도 있지만 때에 따라서는 분석가가 산업별로 특정값을 지정할 때도 있습니다. 이런 경우에는 딕셔너리를 구성하면 됩니다. 

```python
fill_values = {1: 1000, 2: 2000}
fill_func = lambda d: d.fillna(fill_values[d.name])

data_group_value = data.groupby('industry').apply(fill_func)
data_group_value
```

|     | salary | sales        | roe         | industry | missing |
| --- | ------ | ------------ | ----------- | -------- | ------- |
| 0   | 1095.0 | 27595.000000 | 14.100000   | 1        | 0       |
| 1   | 1000.0 | 9958.000000  | 10.900000   | 1        | 1       |
| 2   | 1000.0 | 6125.899902  | 23.500000   | 1        | 1       |
| 3   | 578.0  | 16246.000000 | 5.900000    | 1        | 0       |
| 4   | 1368.0 | 1000.000000  | 13.800000   | 1        | 1       |
| 5   | 1145.0 | 2000.000000  | 20.000000   | 2        | 1       |
| 6   | 1078.0 | 2266.699951  | 16.400000   | 2        | 0       |
| 7   | 1094.0 | 2966.800049  | 16.299999   | 2        | 0       |
| 8   | 1237.0 | 4570.200195  | 10.500000   | 2        | 0       |
| 9   | 833.0  | 2830.000000  | 2000.000000 | 2        | 1       |

##### 변수별 다른 대체방법 적용

`fillna()`이외에도 결측치를 대체하는 판다스 메소드로 `interpolate()`가 있습니다.

```python
DataFrame.interpolate(method='linear', axis=0, limit=None, 
inplace=False, limit_direction=None, limit_area=None, 
downcast=None, **kwargs)
```

`interpolate()`는 보간법이라고 합니다.  보간법의 method로는 선형인 'linear', 시계열인 'time', 다항인 'polynomial', 가장 가까운 것을 선택하는 'nearest' 등이 있습니다. 

salary 변수에는 선형보간법, sales 변수에는 sales 변수의 평균값, roe 변수에는 'missing'이라는 문자열로 결측치를 대체하도록 해보겠습니다.

```python
missing_fill_val = {'salary': data.salary.interpolate(),
                    'sales': data.sales.mean(),
                    'roe': 'missing'}

missing_fill_val
```
```
{'salary': 0    1095.000000
 1     922.666667
 2     750.333333
 3     578.000000
 4    1368.000000
 5    1145.000000
 6    1078.000000
 7    1094.000000
 8    1237.000000
 9     833.000000
 Name: salary, dtype: float64,
 'sales': 9069.825012125,
 'roe': 'missing'}
```
```python
data_multi = data.fillna(missing_fill_val)
data_multi
```

|     | salary      | sales        | roe       | industry | missing |
| --- | ----------- | ------------ | --------- | -------- | ------- |
| 0   | 1095.000000 | 27595.000000 | 14.1      | 1        | 0       |
| 1   | 922.666667  | 9958.000000  | 10.9      | 1        | 1       |
| 2   | 750.333333  | 6125.899902  | 23.5      | 1        | 1       |
| 3   | 578.000000  | 16246.000000 | 5.9       | 1        | 0       |
| 4   | 1368.000000 | 9069.825012  | 13.8      | 1        | 1       |
| 5   | 1145.000000 | 9069.825012  | 20.0      | 2        | 1       |
| 6   | 1078.000000 | 2266.699951  | 16.4      | 2        | 0       |
| 7   | 1094.000000 | 2966.800049  | 16.299999 | 2        | 0       |
| 8   | 1237.000000 | 4570.200195  | 10.5      | 2        | 0       |
| 9   | 833.000000  | 2830.000000  | missing   | 2        | 1       |


